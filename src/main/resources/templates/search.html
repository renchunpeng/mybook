<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://apps.bdimg.com/libs/jquerymobile/1.4.5/jquery.mobile-1.4.5.min.css">
    <script src="https://apps.bdimg.com/libs/jquery/1.10.2/jquery.min.js"></script>
    <script src="https://apps.bdimg.com/libs/jquerymobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>
    <style>
        .mask {
            position: absolute;
            top: 0px;
            filter: alpha(opacity=60);
            background-color: #777;
            z-index: 1002;
            left: 0px;
            opacity: 0.5;
            -moz-opacity: 0.5;
        }
    </style>
</head>

<body>
<div id="mask" class="mask"></div>
<div data-role="page" id="home" data-title="小说搜索">
    <div data-role="header" data-position="fixed">
        <h1>小说搜索</h1>
        <a href="/book" data-ajax="false" data-role="button" class="ui-btn-left" data-icon="back">我到书架</a>
    </div>
    <div data-role="content">
        <form action="">
            <div data-role="fieldcontain">
                <input type="text" name="fullname" id="bookname" placeholder="请输入书名" style="display:block;">
                <a data-role="button" id="search" data-icon="search">搜索</a>
            </div>
        </form>

        <div id="result">
            <ul data-role="listview" data-inset="true">

            </ul>
        </div>
    </div>

</div>

<script>
    $(function () {
        $("#search").click(function () {
            showMask();
            const bookname = $("#bookname").val();
            $.ajax({
                url: '/search/',
                type: 'get',
                dataType: 'json',
                data: {
                    bookname: bookname
                },
                success: function (data) {
                    if (data.length > 0) {
                        updateresult(data);
                    } else {
                        alert("没有查到相关书籍！");
                    }
                    hideMask();
                },
                error: function (error) {
                    console.log(error)
                }
            })
        });
    })

    //根据查询结果刷新result div
    function updateresult(data) {
        var html = "";

        //更新查询结果的时候将以前的查询结果清空
        $('#result>ul').empty();

        for (var i = 0; i < data.length; i++) {
            var item = data[i];

            html += "<li>";

            html += '<a data-ajax="false" href="#" onclick=add("' + item.bookUrl + '") ' +
                '<img src="' + item.bookPicUrl + '">' +
                item.bookName +
                '<br/>' +
                '<span class="ban">' + item.auth + '</span>' +
                '<br/>' +
                '</a>';
            html += "</li>";
        }
        $("#result>ul").append(html);
        $("#result>ul").listview("refresh");
    }

    //显示遮罩层
    function showMask() {
        $('#mask').css("height", $(document).height());
        $('#mask').css("width", $(document).width());
        $('#mask').show();
    }

    //隐藏遮罩层
    function hideMask() {
        $("#mask").hide();
    }

    //添加书籍
    function add(bookUrl) {
        $.ajax({
            url: '/addbook',
            type: 'get',
            dataType: 'json',
            data: {
                url: bookUrl
            },
            success: function (data) {
                alert(data);
            },
            error: function (error) {
                console.log(error)
            }
        })
    }
</script>
</body>
</html>